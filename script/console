#!/usr/bin/rlwrap php5
<?
/*
  PHP on Crutches - Copyright (c) 2008 Markus Koller

  This program is free software; you can redistribute it and/or modify
  it under the terms of the MIT License.

  $Id$
*/

  require dirname(__FILE__).'/../config/environment.php';

  function get($path, $params=null) {
    if (is_array($params)) {
      $_GET = $_POST = $params;
    }
    print Dispatcher::run($path);
  }

  function post($path, $params=null) {
    $_GET = $_POST = (array) $params;
    print Dispatcher::run($path);
  }

  print "\n\n".`php -v`."\n";
  while (!feof(STDIN)) {
    print ">>> ";
    $command = trim(fgets(STDIN));
    if (in_array($command, array('exit', 'quit'))) {
      exit;
    } elseif ($command == 'ls' or substr($command, 0, 3) == 'ls ') {
      print `$command -x --color`;
      continue;
    } elseif (substr($command, 0, 3) == 'cd ') {
      chdir(substr($command, 3));
      print getcwd()."\n";
      continue;
    } elseif ($command == '..') {
      chdir('..');
      print getcwd()."\n";
      continue;
    } elseif (preg_match('/^\$\w+\?$/', $command)) {
      $command = "var_export(".rtrim($command, '?').")";
    } else {
      $command = rtrim($command, ';');
    }

    if ($command) {
      ob_start();
      try {
        eval("\$result = ($command);");
      } catch (Exception $e) {
        $result = $e;
      }

      if ($output = ob_get_clean()) {
        print rtrim($output)."\n";
      }

      print " [1;32m::[0m ";
      if (is_object($result)) {
        print get_class($result);
      } elseif (is_string($result)) {
        var_export($result);
      } elseif (is_null($result)) {
        print 'null';
      } else {
        print $result;
      }
      print "\n";
    }
  }
  print "\n";

# vim: ft=php
?>
